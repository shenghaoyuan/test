/* 
  This file was generated by KreMLin <https://github.com/FStarLang/kremlin>
  KreMLin invocation: krml -verbose -d reachability -I . -I includes -tmpdir /home/shyuan/2-FMCAD2021/riotboot/out/sources -no-prefix FStarFiles /home/shyuan/2-FMCAD2021/riotboot/out/out.krml -ccopt -O0 mymain.c -add-include "kremlin/internal/compat.h" -bundle LowStar.*,Prims -bundle FStar.* -o /home/shyuan/2-FMCAD2021/riotboot/out/main
  F* version: <unknown>
  KreMLin version: 03ccd42f
 */

#include "Slot.h"

bool Slot_riotboot_slot_validate(Riotboot_hdr_t slot)
{
  Riotboot_hdr_t tb = slot;
  bool b = Hdr_riotboot_hdr_validate(&tb);
  return b;
}

FStar_Pervasives_Native_option__Riotboot_hdr_t
Slot_choose_image_aux(
  Prims_int hdrs_len,
  Riotboot_hdr_t *hdrs,
  Prims_int index,
  FStar_Pervasives_Native_option__Riotboot_hdr_t opt
)
{
  switch (Prims_op_Subtraction(Prims_op_Subtraction(hdrs_len, (krml_checked_int_t)1), index))
  {
    case 0:
      {
        Riotboot_hdr_t img = hdrs[FStar_UInt32_uint_to_t(index)];
        bool b = Slot_riotboot_slot_validate(img);
        if (b == false)
          if (opt.tag == FStar_Pervasives_Native_None)
            return opt;
          else if (opt.tag == FStar_Pervasives_Native_Some)
          {
            Riotboot_hdr_t t = opt.v;
            if (img.version <= t.version)
              return
                (
                  (FStar_Pervasives_Native_option__Riotboot_hdr_t){
                    .tag = FStar_Pervasives_Native_Some,
                    .v = img
                  }
                );
            else
              return opt;
          }
          else
          {
            KRML_HOST_EPRINTF("KreMLin abort at %s:%d\n%s\n",
              __FILE__,
              __LINE__,
              "unreachable (pattern matches are exhaustive in F*)");
            KRML_HOST_EXIT(255U);
          }
        else
          return opt;
        break;
      }
    default:
      {
        Riotboot_hdr_t img = hdrs[FStar_UInt32_uint_to_t(index)];
        bool b = Slot_riotboot_slot_validate(img);
        if (b == false)
          if (opt.tag == FStar_Pervasives_Native_None)
            return
              Slot_choose_image_aux(hdrs_len,
                hdrs,
                Prims_op_Addition(index, (krml_checked_int_t)1),
                (
                  (FStar_Pervasives_Native_option__Riotboot_hdr_t){
                    .tag = FStar_Pervasives_Native_Some,
                    .v = img
                  }
                ));
          else if (opt.tag == FStar_Pervasives_Native_Some)
          {
            Riotboot_hdr_t t = opt.v;
            if (img.version <= t.version)
              return
                Slot_choose_image_aux(hdrs_len,
                  hdrs,
                  Prims_op_Addition(index, (krml_checked_int_t)1),
                  opt);
            else
              return
                Slot_choose_image_aux(hdrs_len,
                  hdrs,
                  Prims_op_Addition(index, (krml_checked_int_t)1),
                  (
                    (FStar_Pervasives_Native_option__Riotboot_hdr_t){
                      .tag = FStar_Pervasives_Native_Some,
                      .v = img
                    }
                  ));
          }
          else
          {
            KRML_HOST_EPRINTF("KreMLin abort at %s:%d\n%s\n",
              __FILE__,
              __LINE__,
              "unreachable (pattern matches are exhaustive in F*)");
            KRML_HOST_EXIT(255U);
          }
        else
          return
            Slot_choose_image_aux(hdrs_len,
              hdrs,
              Prims_op_Addition(index, (krml_checked_int_t)1),
              opt);
      }
  }
}

FStar_Pervasives_Native_option__uint32_t
Slot_choose_image(Prims_int hdrs_len, Riotboot_hdr_t *hdrs)
{
  FStar_Pervasives_Native_option__Riotboot_hdr_t
  res =
    Slot_choose_image_aux(hdrs_len,
      hdrs,
      (krml_checked_int_t)0,
      ((FStar_Pervasives_Native_option__Riotboot_hdr_t){ .tag = FStar_Pervasives_Native_None }));
  if (res.tag == FStar_Pervasives_Native_None)
    return ((FStar_Pervasives_Native_option__uint32_t){ .tag = FStar_Pervasives_Native_None });
  else if (res.tag == FStar_Pervasives_Native_Some)
  {
    Riotboot_hdr_t h = res.v;
    return
      (
        (FStar_Pervasives_Native_option__uint32_t){
          .tag = FStar_Pervasives_Native_Some,
          .v = h.start_addr
        }
      );
  }
  else
  {
    KRML_HOST_EPRINTF("KreMLin abort at %s:%d\n%s\n",
      __FILE__,
      __LINE__,
      "unreachable (pattern matches are exhaustive in F*)");
    KRML_HOST_EXIT(255U);
  }
}

